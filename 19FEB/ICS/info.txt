Rewritten from ICS3U6 and ICS4UE.